<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="Orders">
	<!-- 배달신청 -->
	<select resultType="int" parameterType="String" id="getCount"> 
		select count(*) 
		from qworders 
		where did=#{id} and state=1 
	</select>
	<select resultType="int" id="getAllCount">	
		select count(*) 
		from qworders 
		where did is null 
	</select>
	<select resultType="orders.OrdersDataBean" parameterType="String" id="getOrders"> 
		select ONUM,DESTINATION,PRICE,STATE,REG_TIME,DPRICE,FEES,LIMIT_TIME,res_Limit_Time,OPENCHECK,o.DID,s.shop_name sid 
		from qworders o, qwstores s 
		where s.sid = o.sid and o.did=#{id} and state=1 order by onum desc 
	</select>
	<select resultType="orders.OrdersDataBean" id="getAllOrders"> 
		select ONUM,DESTINATION,PRICE,STATE,REG_TIME,DPRICE,FEES,LIMIT_TIME,res_Limit_Time,OPENCHECK,o.DID,s.shop_name sid 
		from qworders o, qwstores s 
		where s.sid = o.sid and o.did is null and state=1 
		order by onum desc 
	</select>
	<update parameterType="Map" id="acceptOrder"> 
		update qworders set state=2, dprice=(select dprice from qwdelivery where did=#{id}), did=#{id} 
		where onum=#{onum} 
	</update>
	<update parameterType="Map" id="refuseOrder"> 
		update qworders set state=3, dprice=0, did=#{id} 
		where onum=#{onum} 
	</update>
	
	<!-- 배달현황 -->
	<select resultType="int" parameterType="String" id="getStateCount"> 
		select count(*) 
		from qworders 
		where did=#{id} and state in(2,3,4,5)
	</select>
	<select resultType="orders.OrdersDataBean" parameterType="String" id="getResOrders"> 
		select ONUM,PRICE,STATE,REG_TIME,DPRICE,FEES,LIMIT_TIME,res_Limit_Time,OPENCHECK,o.DID,s.shop_name sid 
		from qworders o, qwstores s where s.sid = o.sid and did=#{id} and state in(2,3,4,5) 
		order by onum desc, state
	</select>
	<update parameterType="int" id="changeState"> 
		update qworders set state=5 
		where onum=#{onum} 
	</update>
	<update parameterType="int" id="deleteState"> 
		update qworders set state=6 
		where onum=#{onum} 
	</update>
	
	
	
	<insert id="insertOrderOne" parameterType="map">
		insert into qworders values(
			orders_seq.nextval, #{destination}, #{price}, '1', sysdate, #{dprice}, #{fees},
			<choose>
				<!-- 30분 -->
				<when test="limit_time == 30">	
					sysdate + 1/48
				</when>
				<!-- 40분 -->
				<when test="limit_time == 40">	
					sysdate + 40/1440
				</when>
				<!-- 50분 -->
				<when test="limit_time == 50">	
					sysdate + 50/1440
				</when>
				<!-- 60분 -->
				<when test="limit_time == 60">	
					sysdate + 1/24
				</when>
				<otherwise>
			      	sysdate
			    </otherwise>
			</choose>
			, 
			<choose>
				<!-- 10분 -->
				<when test='res_limit_time == "y"'>	
					sysdate + 10/1440
				</when>
				<otherwise>
					sysdate
				</otherwise>
			</choose>
			, #{opencheck}, #{did}, #{sid}			
		)
	</insert>
	
	<insert id="insertOrderAll" parameterType="map">
		insert into qworders(onum, destination, price, state, reg_time, fees,
			limit_time, res_limit_time, opencheck, sid) values(
			orders_seq.nextval, #{destination}, #{price}, '1', sysdate, #{fees},
			<choose>
				<when test="limit_time == 30">	
					sysdate + 1/48
				</when>
				<when test="limit_time == 40">	
					sysdate + 40/1440
				</when>
				<when test="limit_time == 50">	
					sysdate + 50/1440
				</when>
				<when test="limit_time == 60">	
					sysdate + 1/24
				</when>
				<otherwise>
			      	sysdate
			    </otherwise>
			</choose>
			, 
			<choose>
				<when test='res_limit_time == "y"'>	
					sysdate + 10/1440	
				</when>
				<otherwise>
					sysdate
				</otherwise>
			</choose>
			, #{opencheck}, #{sid}			
		)
	</insert>
	
	<!-- 관리자 -->
	<select id="adminGetOrders" resultType="orders.OrdersDataBean">
		select * from qworders where state!=4 and state!=5 and state!=6
	</select>
	<update id="updateCurrent" parameterType="int">
		update qworders set state=4 where onum=#{onum}
	</update>
</mapper> 